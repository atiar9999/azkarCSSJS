// Data for Azkar
const azkarData = {
    morning: [
        {
            id: 1,
            text: "أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلّٰهِ، وَالْحَمْدُ لِلّٰهِ، لَا إِلٰهَ إِلَّا اللّٰهُ وَحْدَهُ لاَ شَرِيْكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيْرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِيْ هٰذَا الْيَوْمِ وَخَيْرَ مَا بَعْدَهُ، وَأَعُوْذُ بِكَ مِنْ شَرِّ مَا فِيْ هٰذَا الْيَوْمِ وَشَرِّ مَا بَعْدَهُ، رَبِّ أَعُوْذُ بِكَ مِنَ الْكَسَلِ وَسُوْءِ الْكِبَرِ، رَبِّ أَعُوْذُ بِكَ مِنْ عَذَابٍ فِيْ النَّارِ وَعَذَابٍ فِيْ الْقَبْرِ",
            translation: "We have reached the morning and at this very time all sovereignty belongs to Allah, and all praise is for Allah. None has the right to be worshipped except Allah, alone, without partner, to Him belongs all sovereignty and praise and He is over all things omnipotent.",
            recommendedCount: 1
        },
        {
            id: 2,
            text: "اللّٰهُمَّ إِنِّيْ أَصْبَحْتُ أُشْهِدُكَ، وَأُشْهِدُ حَمَلَةَ عَرْشِكَ، وَمَلَاىِٕكَتَكَ، وَجَمِيْعَ خَلْقِكَ، أَنَّكَ أَنْتَ اللّٰهُ لَا إِلٰهَ إِلَّا أَنْتَ وَحْدَكَ لَا شَرِيْكَ لَكَ، وَأَنَّ مُحَمَّدًا عَبْدُكَ وَرَسُوْلُكَ",
            translation: "O Allah, verily I have reached the morning and call on You, the bearers of Your throne, Your angels, and all of Your creation to witness that You are Allah, none has the right to be worshipped except You, alone, without partner and that Muhammad is Your Servant and Messenger.",
            recommendedCount: 4
        },
        {
            id: 3,
            text: "اللّٰهُمَّ مَا أَصْبَحَ بِيْ مِنْ نِعْمَةٍ أَوْ بِأَحَدٍ مِنْ خَلْقِكَ فَمِنْكَ وَحْدَكَ لَا شَرِيْكَ لَكَ، فَلَكَ الْحَمْدُ وَلَكَ الشُّكْرُ",
            translation: "O Allah, what blessing I or any of Your creation have risen upon, is from You alone, without partner, so for You is all praise and unto You all thanks.",
            recommendedCount: 1
        },
        {
            id: 4,
            text: "اللّٰهُمَّ عَافِنِيْ فِيْ بَدَنِيْ، اَللّٰهُمَّ عَافِنِيْ فِيْ سَمْعِيْ، اَللّٰهُمَّ عَافِنِيْ فِيْ بَصَرِيْ، لَا إِلٰهَ إِلَّا أَنْتَ، اَللّٰهُمَّ إِنِّيْ أَعُوْذُ بِكَ مِنَ الْكُفْرِ، وَالْفَقْرِ، وَأَعُوْذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلٰهَ إِلَّا أَنْتَ",
            translation: "O Allah, grant my body health, O Allah, grant my hearing health, O Allah, grant my sight health. None has the right to be worshipped except You. O Allah, I take refuge with You from disbelief and poverty, and I take refuge with You from the punishment of the grave. None has the right to be worshipped except You.",
            recommendedCount: 3
        },
        {
            id: 5,
            text: "حَسْبِيَ اللّٰهُ لَا إِلٰهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيْمِ",
            translation: "Allah is Sufficient for me, none has the right to be worshipped except Him, upon Him I rely and He is Lord of the exalted throne.",
            recommendedCount: 7
        }
    ],
    evening: [
        {
            id: 6,
            text: "أَمْسَيْنَا وَأَمْسٰى الْمُلْكُ لِلّٰهِ، وَالْحَمْدُ لِلّٰهِ، لَا إِلٰهَ إِلَّا اللّٰهُ وَحْدَهُ لاَ شَرِيْكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيْرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِيْ هٰذِهِ اللَّيْلَةِ وَخَيْرَ مَا بَعْدَهَا، وَأَعُوْذُ بِكَ مِنْ شَرِّ مَا فِيْ هٰذِهِ اللَّيْلَةِ وَشَرِّ مَا بَعْدَهَا، رَبِّ أَعُوْذُ بِكَ مِنَ الْكَسَلِ وَسُوْءِ الْكِبَرِ، رَبِّ أَعُوْذُ بِكَ مِنْ عَذابٍ فِيْ النَّارِ وَعَذَابٍ فِيْ الْقَبْرِ",
            translation: "We have reached the evening and at this very time all sovereignty belongs to Allah, and all praise is for Allah. None has the right to be worshipped except Allah, alone, without partner, to Him belongs all sovereignty and praise and He is over all things omnipotent.",
            recommendedCount: 1
        },
        {
            id: 7,
            text: "اللّٰهُمَّ إِنِّيْ أَمْسَيْتُ أُشْهِدُكَ، وَأُشْهِدُ حَمَلَةَ عَرْشِكَ، وَمَلَاىِٕكَتَكَ، وَجَمِيْعَ خَلْقِكَ، أَنَّكَ أَنْتَ اللّٰهُ لَا إِلٰهَ إِلَّا أَنْتَ وَحْدَكَ لَا شَرِيْكَ لَكَ، وَأَنَّ مُحَمَّدًا عَبْدُكَ وَرَسُوْلُكَ",
            translation: "O Allah, verily I have reached the evening and call on You, the bearers of Your throne, Your angels, and all of Your creation to witness that You are Allah, none has the right to be worshipped except You, alone, without partner and that Muhammad is Your Servant and Messenger.",
            recommendedCount: 4
        },
        {
            id: 8,
            text: "اللّٰهُمَّ مَا أَمْسَى بِيْ مِنْ نِعْمَةٍ أَوْ بِأَحَدٍ مِنْ خَلْقِكَ فَمِنْكَ وَحْدَكَ لَا شَرِيْكَ لَكَ، فَلَكَ الْحَمْدُ وَلَكَ الشُّكْرُ",
            translation: "O Allah, what blessing I or any of Your creation have eveninged upon, is from You alone, without partner, so for You is all praise and unto You all thanks.",
            recommendedCount: 1
        },
        {
            id: 9,
            text: "اللّٰهُمَّ عَافِنِيْ فِيْ بَدَنِيْ، اَللّٰهُمَّ عَافِنِيْ فِيْ سَمْعِيْ، اَللّٰهُمَّ عَافِنِيْ فِيْ بَصَرِيْ، لَا إِلٰهَ إِلَّا أَنْتَ، اَللّٰهُمَّ إِنِّيْ أَعُوْذُ بِكَ مِنَ الْكُفْرِ، وَالْفَقْرِ، وَأَعُوْذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلٰهَ إِلَّا أَنْتَ",
            translation: "O Allah, grant my body health, O Allah, grant my hearing health, O Allah, grant my sight health. None has the right to be worshipped except You. O Allah, I take refuge with You from disbelief and poverty, and I take refuge with You from the punishment of the grave. None has the right to be worshipped except You.",
            recommendedCount: 3
        },
        {
            id: 10,
            text: "حَسْبِيَ اللّٰهُ لَا إِلٰهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيْمِ",
            translation: "Allah is Sufficient for me, none has the right to be worshipped except Him, upon Him I rely and He is Lord of the exalted throne.",
            recommendedCount: 7
        }
    ]
};

// App State
const state = {
    favorites: new Set(),
    currentCounts: {},
    currentTime: null,
    theme: localStorage.getItem('theme') || 'light',
    isPlaying: false,
    currentAudio: null,
    currentAzkarIndex: 0,
    currentAzkarType: 'morning'
};

// DOM Elements
const elements = {
    themeToggle: document.getElementById('themeToggle'),
    themeToggleMobile: document.getElementById('themeToggleMobile'),
    menuToggle: document.getElementById('menuToggle'),
    mobileMenu: document.getElementById('mobileMenu'),
    currentTime: document.getElementById('currentTime'),
    timeIndicator: document.getElementById('timeIndicator'),
    timeMessage: document.getElementById('timeMessage'),
    timeIcon: document.getElementById('timeIcon'),
    morningGrid: document.querySelector('#morning .azkar-grid'),
    eveningGrid: document.querySelector('#evening .azkar-grid'),
    favoritesContainer: document.getElementById('favoritesContainer'),
    emptyFavorites: document.getElementById('emptyFavorites'),
    playAudioBtn: document.getElementById('playAudioBtn'),
    audioPlayer: document.getElementById('audioPlayer'),
    playBtn: document.getElementById('playBtn'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    closePlayer: document.getElementById('closePlayer'),
    progressBar: document.getElementById('progressBar'),
    progressFill: document.getElementById('progressFill'),
    backToTop: document.getElementById('backToTop'),
    toast: document.getElementById('toast'),
    navLinks: document.querySelectorAll('.nav-link'),
    mobileNavLinks: document.querySelectorAll('.mobile-nav-link')
};

// Initialize App
class AzkarApp {
    constructor() {
        this.init();
    }

    init() {
        this.loadState();
        this.setupTheme();
        this.setupEventListeners();
        this.updateTime();
        this.renderAzkar();
        this.renderFavorites();
        this.updateProgressIndicator();
        this.setupIntersectionObserver();
        this.animateHero();
        
        // Start time update interval
        setInterval(() => this.updateTime(), 1000);
        
        // Update scroll progress
        window.addEventListener('scroll', () => this.updateProgressIndicator());
    }

    setupTheme() {
        document.documentElement.setAttribute('data-theme', state.theme);
        const icon = elements.themeToggle.querySelector('i');
        icon.className = state.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        if (elements.themeToggleMobile) {
            elements.themeToggleMobile.checked = state.theme === 'dark';
        }
    }

    setupEventListeners() {
        // Theme toggles
        elements.themeToggle.addEventListener('click', () => this.toggleTheme());
        if (elements.themeToggleMobile) {
            elements.themeToggleMobile.addEventListener('change', (e) => {
                state.theme = e.target.checked ? 'dark' : 'light';
                this.setupTheme();
                this.saveState();
            });
        }

        // Mobile menu
        elements.menuToggle.addEventListener('click', () => {
            elements.mobileMenu.classList.toggle('active');
        });

        // Close mobile menu when clicking a link
        elements.mobileNavLinks.forEach(link => {
            link.addEventListener('click', () => {
                elements.mobileMenu.classList.remove('active');
            });
        });

        // Navigation
        elements.navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.getAttribute('href');
                document.querySelector(target).scrollIntoView({
                    behavior: 'smooth'
                });
                
                // Update active nav link
                elements.navLinks.forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
            });
        });

        // Audio player
        elements.playAudioBtn.addEventListener('click', () => this.toggleAudioPlayer());
        elements.playBtn.addEventListener('click', () => this.togglePlayPause());
        elements.prevBtn.addEventListener('click', () => this.playPrevious());
        elements.nextBtn.addEventListener('click', () => this.playNext());
        elements.closePlayer.addEventListener('click', () => this.closeAudioPlayer());

        // Back to top
        elements.backToTop.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Hide audio player when scrolling
        let lastScroll = 0;
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            if (currentScroll > lastScroll && currentScroll > 100) {
                elements.audioPlayer.classList.remove('active');
            }
            lastScroll = currentScroll;
        });
    }

    toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        this.setupTheme();
        this.saveState();
        this.showToast(`Switched to ${state.theme} mode`);
    }

    updateTime() {
        const now = new Date();
        state.currentTime = now;
        
        // Format time
        const timeString = now.toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        if (elements.currentTime) {
            elements.currentTime.textContent = timeString;
        }
        
        // Update time indicator
        const hour = now.getHours();
        let message = '';
        let icon = '';
        
        if (hour >= 5 && hour < 12) {
            message = 'Good Morning - وقت الصباح';
            icon = 'fa-sun';
        } else if (hour >= 12 && hour < 17) {
            message = 'Good Afternoon - وقت الظهيرة';
            icon = 'fa-sun';
        } else if (hour >= 17 && hour < 20) {
            message = 'Good Evening - وقت المساء';
            icon = 'fa-sunset';
        } else {
            message = 'Good Night - وقت الليل';
            icon = 'fa-moon';
        }
        
        if (elements.timeMessage && elements.timeIcon) {
            elements.timeMessage.textContent = message;
            elements.timeIcon.className = `fas ${icon}`;
        }
    }

    renderAzkar() {
        // Render morning azkar
        azkarData.morning.forEach(azkar => {
            const card = this.createAzkarCard(azkar, 'morning');
            elements.morningGrid.appendChild(card);
        });

        // Render evening azkar
        azkarData.evening.forEach(azkar => {
            const card = this.createAzkarCard(azkar, 'evening');
            elements.eveningGrid.appendChild(card);
        });
    }

    createAzkarCard(azkar, type) {
        const card = document.createElement('div');
        card.className = 'azkar-card';
        card.dataset.id = azkar.id;
        card.dataset.type = type;

        const isFavorite = state.favorites.has(azkar.id.toString());
        const currentCount = state.currentCounts[azkar.id] || 0;

        card.innerHTML = `
            <div class="azkar-content">
                <div class="azkar-text arabic">${azkar.text}</div>
                <div class="azkar-translation">${azkar.translation}</div>
            </div>
            <div class="azkar-actions">
                <div class="azkar-counter">
                    <button class="counter-btn minus" aria-label="Decrease count">
                        <i class="fas fa-minus"></i>
                    </button>
                    <div class="counter-display">
                        <span class="current">${currentCount}</span>
                        <span class="separator">/</span>
                        <span class="recommended">${azkar.recommendedCount}</span>
                    </div>
                    <button class="counter-btn plus" aria-label="Increase count">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <button class="action-btn favorite ${isFavorite ? 'favorite' : ''}" 
                        aria-label="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                    <i class="fas ${isFavorite ? 'fa-heart' : 'fa-heart'}"></i>
                </button>
            </div>
        `;

        // Add event listeners
        const minusBtn = card.querySelector('.minus');
        const plusBtn = card.querySelector('.plus');
        const favoriteBtn = card.querySelector('.favorite');
        const currentDisplay = card.querySelector('.current');

        minusBtn.addEventListener('click', () => {
            this.updateCount(azkar.id, -1, currentDisplay);
        });

        plusBtn.addEventListener('click', () => {
            this.updateCount(azkar.id, 1, currentDisplay);
        });

        favoriteBtn.addEventListener('click', () => {
            this.toggleFavorite(azkar.id, favoriteBtn);
        });

        return card;
    }

    updateCount(azkarId, change, displayElement) {
        const current = state.currentCounts[azkarId] || 0;
        const newCount = Math.max(0, current + change);
        
        state.currentCounts[azkarId] = newCount;
        displayElement.textContent = newCount;
        
        // Visual feedback
        const card = displayElement.closest('.azkar-card');
        card.style.transform = 'scale(1.02)';
        setTimeout(() => {
            card.style.transform = '';
        }, 150);
        
        this.saveState();
    }

    toggleFavorite(azkarId, button) {
        const idStr = azkarId.toString();
        
        if (state.favorites.has(idStr)) {
            state.favorites.delete(idStr);
            button.classList.remove('favorite');
            button.setAttribute('aria-label', 'Add to favorites');
            button.querySelector('i').style.color = '';
            this.showToast('Removed from favorites');
        } else {
            state.favorites.add(idStr);
            button.classList.add('favorite');
            button.setAttribute('aria-label', 'Remove from favorites');
            button.querySelector('i').style.color = '#f56565';
            this.showToast('Added to favorites');
        }
        
        this.renderFavorites();
        this.saveState();
    }

    renderFavorites() {
        const favorites = Array.from(state.favorites)
            .map(id => {
                // Find azkar in morning or evening data
                const azkar = [...azkarData.morning, ...azkarData.evening]
                    .find(a => a.id.toString() === id);
                return azkar;
            })
            .filter(azkar => azkar); // Remove any undefined values

        if (favorites.length === 0) {
            elements.favoritesContainer.innerHTML = elements.emptyFavorites.outerHTML;
            return;
        }

        // Clear container but keep empty state element for reuse
        elements.favoritesContainer.innerHTML = '';

        // Create favorites grid
        const grid = document.createElement('div');
        grid.className = 'azkar-grid';
        
        favorites.forEach(azkar => {
            const card = this.createAzkarCard(azkar, 'favorites');
            grid.appendChild(card);
        });
        
        elements.favoritesContainer.appendChild(grid);
    }

    toggleAudioPlayer() {
        elements.audioPlayer.classList.toggle('active');
        if (elements.audioPlayer.classList.contains('active')) {
            this.playAzkarAudio();
        } else {
            this.pauseAudio();
        }
    }

    playAzkarAudio() {
        // In a real app, this would play actual audio files
        // For now, we'll simulate audio playback
        
        state.isPlaying = true;
        elements.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        
        // Simulate audio progress
        let progress = 0;
        const interval = setInterval(() => {
            if (!state.isPlaying) {
                clearInterval(interval);
                return;
            }
            
            progress += 0.5;
            if (progress > 100) {
                progress = 0;
                this.playNext();
            }
            
            elements.progressBar.style.width = `${progress}%`;
        }, 100);
        
        state.currentAudio = {
            interval,
            progress
        };
    }

    pauseAudio() {
        state.isPlaying = false;
        elements.playBtn.innerHTML = '<i class="fas fa-play"></i>';
        
        if (state.currentAudio) {
            clearInterval(state.currentAudio.interval);
        }
    }

    togglePlayPause() {
        if (state.isPlaying) {
            this.pauseAudio();
        } else {
            this.playAzkarAudio();
        }
    }

    playPrevious() {
        state.currentAzkarIndex = Math.max(0, state.currentAzkarIndex - 1);
        this.playAzkarAudio();
        this.showToast('Playing previous azkar');
    }

    playNext() {
        const currentList = azkarData[state.currentAzkarType];
        state.currentAzkarIndex = (state.currentAzkarIndex + 1) % currentList.length;
        this.playAzkarAudio();
        this.showToast('Playing next azkar');
    }

    closeAudioPlayer() {
        elements.audioPlayer.classList.remove('active');
        this.pauseAudio();
    }

    updateProgressIndicator() {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        
        elements.progressFill.style.width = scrolled + '%';
        
        // Show/hide back to top button
        if (winScroll > 300) {
            elements.backToTop.classList.add('visible');
        } else {
            elements.backToTop.classList.remove('visible');
        }
    }

    setupIntersectionObserver() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    
                    // Update active nav link
                    const id = entry.target.getAttribute('id');
                    elements.navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href') === `#${id}`) {
                            link.classList.add('active');
                        }
                    });
                }
            });
        }, {
            threshold: 0.1
        });

        // Observe sections
        document.querySelectorAll('.section').forEach(section => {
            observer.observe(section);
        });
    }

    animateHero() {
        // Add animation to hero elements
        const heroTitle = document.querySelector('.hero-title');
        const heroSubtitle = document.querySelector('.hero-subtitle');
        const heroActions = document.querySelector('.hero-actions');

        heroTitle.style.animation = 'fadeInUp 1s ease-out';
        heroSubtitle.style.animation = 'fadeInUp 1s ease-out 0.2s both';
        heroActions.style.animation = 'fadeInUp 1s ease-out 0.4s both';
    }

    showToast(message) {
        elements.toast.textContent = message;
        elements.toast.classList.add('show');
        
        setTimeout(() => {
            elements.toast.classList.remove('show');
        }, 3000);
    }

    loadState() {
        try {
            const savedState = localStorage.getItem('azkarAppState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                state.favorites = new Set(parsed.favorites || []);
                state.currentCounts = parsed.currentCounts || {};
                state.theme = parsed.theme || 'light';
            }
        } catch (e) {
            console.error('Failed to load state:', e);
        }
    }

    saveState() {
        try {
            const stateToSave = {
                favorites: Array.from(state.favorites),
                currentCounts: state.currentCounts,
                theme: state.theme
            };
            localStorage.setItem('azkarAppState', JSON.stringify(stateToSave));
        } catch (e) {
            console.error('Failed to save state:', e);
        }
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new AzkarApp();
});

// Register service worker for PWA functionality
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(error => {
            console.log('ServiceWorker registration failed:', error);
        });
    });
}